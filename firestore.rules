rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection - only authenticated users can read/write their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Products collection - authenticated users can read/write
    match /products/{productId} {
      allow read: if request.auth != null;

      allow create: if request.auth != null
        && validateProductCreate(request.resource.data);

      allow update: if request.auth != null
        && validateProductUpdate(request.resource.data, resource.data);
    }

    // Product stock history subcollection - authenticated users can read/write
    match /products/{productId}/stockHistory/{historyId} {
      allow read, write: if request.auth != null;
    }
    
    // Sales collection - authenticated users can read/write
    match /sales/{saleId} {
      allow read, write: if request.auth != null;
      
      // Validate sale data structure
      allow create: if request.auth != null 
        && validateSaleData(resource.data);
    }
    
    // Stock movements collection - authenticated users can read/write with validation
    match /stockMovements/{movementId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null 
        && validateStockMovementData(resource.data);
      allow update: if request.auth != null 
        && validateStockMovementData(resource.data);
    }
    
    // Settings collection - admins can manage, authorized emails can read
    match /settings/{settingId} {
      allow read: if request.auth != null 
        && (isAdmin(request.auth.uid) || isAuthorizedSettingsViewer());
      allow write: if request.auth != null 
        && isAdmin(request.auth.uid);
    }
    
    // Helper functions
    function validateProductCreate(data) {
      return data.keys().hasAll(['name', 'category', 'currentStock', 'minStock', 'price', 'unit'])
        && data.name is string
        && data.category is string
        && data.currentStock is number
        && data.minStock is number
        && data.price is number
        && data.unit is string
        && data.currentStock >= 0
        && data.minStock >= 0
        && data.price >= 0;
    }

    function validateProductUpdate(incoming, existing) {
      let nameValue = incoming.name != null ? incoming.name : existing.name;
      let categoryValue = incoming.category != null ? incoming.category : existing.category;
      let currentStockValue = incoming.currentStock != null ? incoming.currentStock : existing.currentStock;
      let minStockValue = incoming.minStock != null ? incoming.minStock : existing.minStock;
      let priceValue = incoming.price != null ? incoming.price : existing.price;
      let unitValue = incoming.unit != null ? incoming.unit : existing.unit;

      return nameValue is string
        && categoryValue is string
        && currentStockValue is number
        && minStockValue is number
        && priceValue is number
        && unitValue is string
        && currentStockValue >= 0
        && minStockValue >= 0
        && priceValue >= 0;
    }
    
    function validateSaleData(data) {
      return data.keys().hasAll(['productId', 'productName', 'quantity', 'unitPrice', 'totalAmount', 'customerName'])
        && data.productId is string
        && data.productName is string
        && data.quantity is number
        && data.unitPrice is number
        && data.totalAmount is number
        && data.customerName is string
        && data.quantity > 0
        && data.unitPrice >= 0
        && data.totalAmount >= 0;
    }

    function validateStockMovementData(data) {
      return data.keys().hasAll(['productId', 'quantity', 'type', 'reason', 'timestamp'])
        && data.productId is string
        && data.quantity is number
        && data.type in ['in', 'out']
        && data.reason is string
        && data.timestamp is timestamp
        && data.quantity != 0;
    }
    
    function isAdmin(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role == 'admin';
    }

    function isAuthorizedSettingsViewer() {
      let email = request.auth.token.email;
      let emailLower = email != null ? lower(email) : null;
      return email != null
        && resource.data.authorizedEmails != null
        && (
          resource.data.authorizedEmails.hasAny([email]) ||
          resource.data.authorizedEmails.hasAny([emailLower])
        );
    }
  }
}
